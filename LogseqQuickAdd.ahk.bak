;------------------------------------------------------------------------------
;                           LogseqQuickadd
;
; A way to easily capture your clipboard or anything you would like to Logseq.
;
;
;                       Created by Kenneth Aar
;                       Modified with GUI interface
;
;------------------------------------------------------------------------------
;SETTINGS
;------------------------------------------------------------------------------
#Requires AutoHotkey v2.0+
#SingleInstance force

;------------------------------------------------------------------------------
; Global Variables - Must be declared first
;------------------------------------------------------------------------------
global VarScriptName := "LogseqQuickAdd"
global VarVersionNo := "v012"
global Varblurb := "`nPress SHIFT+CTRL+L to add`nyour clipboard as task to Logseq"
global customDir := ""
global taskGui := ""
global taskInputHwnd := 0  ; Store the hwnd of the task input control
global iniPath := A_ScriptDir "\" VarScriptName ".ini"

;------------------------------------------------------------------------------
; Helper Functions - Define before using them
;------------------------------------------------------------------------------

; Function to process multiline text for Logseq
ProcessMultilineText(taskText, statusPrefix, contextSuffix) {
    ; Check if the text contains newlines
    if (InStr(taskText, "`n") || InStr(taskText, "`r")) {
        ; Split text into lines
        lines := StrSplit(taskText, "`n", "`r")

        ; First line becomes the main TODO
        firstLine := Trim(lines[1])
        result := statusPrefix . firstLine

        ; Add context right after first line (if exists)
        if (contextSuffix != "") {
            result .= "`n" . contextSuffix
        }

        ; Remaining lines become sub-blocks (indented with two spaces and "- " prefix)
        if (lines.Length > 1) {
            Loop lines.Length - 1 {
                lineIndex := A_Index + 1
                lineText := Trim(lines[lineIndex])
                if (lineText != "") {
                    result .= "`n  - " . lineText
                }
            }
        }

        return result
    } else {
        ; Single line text
        result := statusPrefix . taskText
        if (contextSuffix != "") {
            result .= "`n" . contextSuffix
        }
        return result
    }
}

; Function to save task to Logseq journal
SaveTask(openLogseq := false) {
    global taskGui, customDir, iniPath, VarScriptName, VarVersionNo

    ; Double-check that we have the path from INI
    if (customDir = "") {
        customDir := IniRead(iniPath, "General", "CustomPath", "")
        if (customDir = "") {
            MsgBox "Cannot find the journal folder path in the INI file. Please select it again.", "Error - " VarScriptName
            if !newDir := DirSelect()
                return
            customDir := newDir
            IniWrite(customDir, iniPath, "General", "CustomPath")
        }
    }

    ; Get the submitted values
    savedValues := taskGui.Submit(false)  ; false to not destroy the GUI yet

    ; Determine the status prefix
    statusPrefix := "- "  ; Start with dash and space for Logseq tasks
    if (savedValues.TodoCheck)
        statusPrefix .= "TODO "
    else if (savedValues.WaitingCheck)
        statusPrefix .= "WAITING "
    else if (savedValues.DoingCheck)
        statusPrefix .= "DOING "

    ; Get the task text
    taskText := savedValues.TaskInput

    ; Determine context suffix (not indented, goes right after first line)
    contextSuffix := ""
    contextName := ""
    if (savedValues.PCCheck) {
        contextSuffix := "context:: [[c/PC]]"
        contextName := "PC"
    } else if (savedValues.OfficeCheck) {
        contextSuffix := "context:: [[c/Office]]"
        contextName := "Office"
    } else if (savedValues.HomeCheck) {
        contextSuffix := "context:: [[c/Home]]"
        contextName := "Home"
    } else if (savedValues.GardenCheck) {
        contextSuffix := "context:: [[c/Garden]]"
        contextName := "Garden"
    } else if (savedValues.ErrandsCheck) {
        contextSuffix := "context:: [[c/Errands]]"
        contextName := "Errands"
    }

    ; Process multiline text (context is added inside this function)
    processedTask := ProcessMultilineText(taskText, statusPrefix, contextSuffix)

    ; Combine everything
    finalText := processedTask . "`n- " . "`n"

    ; Path to Logseq Journals folder
    CaptureFilePath := customDir "\" A_YYYY "_" A_MM "_" A_DD ".md"

    ; Check if file exists and what its last line contains
    fileExistsAlready := FileExist(CaptureFilePath)
    shouldAddNewline := true

    if (fileExistsAlready) {
        ; Read the last few characters to check how the file ends
        Try {
            fileContent := FileRead(CaptureFilePath)
            if (fileContent != "") {
                ; If file ends with a newline, we're good to go
                if (SubStr(fileContent, -1) == "`n") {
                    shouldAddNewline := false
                }
            }
        } Catch {
            ; If we can't read the file, just be safe and add a newline
            shouldAddNewline := true
        }
    }

    ; Prepare the text to append
    if (shouldAddNewline) {
        finalText := "`n" . processedTask . "`n"
    } else {
        finalText := processedTask . "`n"
    }

    ; Append to file
    Try {
        FileAppend(finalText, CaptureFilePath)

        ; Create detailed confirmation message with path
        confirmMsg := "Task added to:`n" . CaptureFilePath
        if (contextName != "") {
            confirmMsg .= "`n`nContext: " . contextName
        }

        TrayTip confirmMsg, VarScriptName " " VarVersionNo, 1
    } Catch as err {
        MsgBox "Error writing to file: " CaptureFilePath "`n`nError: " err.Message "`n`nMake sure the path exists and is writable.", "Error - " VarScriptName
    }

    ; Destroy the GUI
    taskGui.Destroy()

    ; Open Logseq if requested
    if (openLogseq) {
        Try {
            WinActivate "ahk_exe Logseq.exe"
        } Catch {
            TrayTip "Logseq is not started", VarScriptName " " VarVersionNo, 1
        }
    }
}

; Button event handlers
SubmitButtonHandler(ctrl, *) {
    SaveTask(false)
}

SubmitAndOpenButtonHandler(ctrl, *) {
    SaveTask(true)
}

CancelButtonHandler(ctrl, *) {
    global taskGui
    taskGui.Destroy()
    TrayTip "Task creation cancelled", VarScriptName " " VarVersionNo, 1
}

; Function to show the main GUI
ShowLogseqAddGUI(clipText := "") {
    global taskGui, taskInputHwnd

    ; Create the GUI
    taskGui := Gui("+AlwaysOnTop +Resize", VarScriptName " " VarVersionNo)

    ; Add status checkboxes (TODO, WAITING, DOING)
    taskGui.Add("Text", "w400", "Task Status:")
    statusGroup := taskGui.Add("GroupBox", "w400 h60", "Status")

    cbTodo := taskGui.Add("Checkbox", "xp+10 yp+25 vTodoCheck Checked", "TODO")
    cbWaiting := taskGui.Add("Checkbox", "x+20 yp vWaitingCheck", "WAITING")
    cbDoing := taskGui.Add("Checkbox", "x+20 yp vDoingCheck", "DOING")

    ; Add task input field
    taskGui.Add("Text", "xm y+20 w400", "Task Description:")
    taskInput := taskGui.Add("Edit", "xm w400 r4 vTaskInput", clipText)

    ; Store the hwnd of the task input for our window message handler
    taskInputHwnd := taskInput.Hwnd

    ; Add context checkboxes
    taskGui.Add("Text", "xm y+20 w400", "Context:")
    contextGroup := taskGui.Add("GroupBox", "w400 h60", "Context")

    cbPC := taskGui.Add("Checkbox", "xp+10 yp+25 vPCCheck", "PC (1)")
    cbOffice := taskGui.Add("Checkbox", "x+10 yp vOfficeCheck", "Office (2)")
    cbHome := taskGui.Add("Checkbox", "x+10 yp vHomeCheck", "Home (3)")
    cbGarden := taskGui.Add("Checkbox", "x+10 yp vGardenCheck", "Garden (4)")
    cbErrands := taskGui.Add("Checkbox", "x+10 yp vErrandsCheck", "Errands (5)")

    ; Add buttons
    submitBtn := taskGui.Add("Button", "xm y+30 w120 Default", "Submit")
    submitBtn.OnEvent("Click", SubmitButtonHandler)

    submitOpenBtn := taskGui.Add("Button", "x+10 w150", "Submit and Open")
    submitOpenBtn.OnEvent("Click", SubmitAndOpenButtonHandler)

    cancelBtn := taskGui.Add("Button", "x+10 w100", "Cancel")
    cancelBtn.OnEvent("Click", CancelButtonHandler)

    ; Add keyboard shortcuts info
    taskGui.Add("Text", "xm y+10 w400", "Shortcuts (only work when NOT typing in the text field):")

    ; Set up events for this GUI
    taskGui.OnEvent("Close", CancelButtonHandler)
    taskGui.OnEvent("Escape", CancelButtonHandler)

    ; Set up WM_CHAR handler for the entire window to intercept key presses
    OnMessage(0x0102, HandleChar)  ; WM_CHAR message

    ; Focus on the task input initially
    taskInput.Focus()

    ; Show the GUI
    taskGui.Show()
}

; Handle WM_CHAR message to intercept key presses
HandleChar(wParam, lParam, msg, hwnd) {
    global taskGui, taskInputHwnd

    ; Skip processing if the GUI doesn't exist
    if (!taskGui || !IsObject(taskGui))
        return

    ; Only process keypresses when focus is NOT on our text input
    currentFocusHwnd := ControlGetFocus("ahk_id " taskGui.Hwnd)
    if (currentFocusHwnd == taskInputHwnd)
        return  ; Let normal typing work in the text field

    ; Get the character typed
    char := Chr(wParam)

    ; Process the character
    Switch char {
        case "t", "T":
            taskGui["TodoCheck"].Value := 1
            taskGui["WaitingCheck"].Value := 0
            taskGui["DoingCheck"].Value := 0
            return 0  ; Prevent the character from being processed further

        case "w", "W":
            taskGui["TodoCheck"].Value := 0
            taskGui["WaitingCheck"].Value := 1
            taskGui["DoingCheck"].Value := 0
            return 0

        case "d", "D":
            taskGui["TodoCheck"].Value := 0
            taskGui["WaitingCheck"].Value := 0
            taskGui["DoingCheck"].Value := 1
            return 0

        case "1":
            taskGui["PCCheck"].Value := 1
            taskGui["OfficeCheck"].Value := 0
            taskGui["HomeCheck"].Value := 0
            taskGui["GardenCheck"].Value := 0
            taskGui["ErrandsCheck"].Value := 0
            return 0

        case "2":
            taskGui["PCCheck"].Value := 0
            taskGui["OfficeCheck"].Value := 1
            taskGui["HomeCheck"].Value := 0
            taskGui["GardenCheck"].Value := 0
            taskGui["ErrandsCheck"].Value := 0
            return 0

        case "3":
            taskGui["PCCheck"].Value := 0
            taskGui["OfficeCheck"].Value := 0
            taskGui["HomeCheck"].Value := 1
            taskGui["GardenCheck"].Value := 0
            taskGui["ErrandsCheck"].Value := 0
            return 0

        case "4":
            taskGui["PCCheck"].Value := 0
            taskGui["OfficeCheck"].Value := 0
            taskGui["HomeCheck"].Value := 0
            taskGui["GardenCheck"].Value := 1
            taskGui["ErrandsCheck"].Value := 0
            return 0

        case "5":
            taskGui["PCCheck"].Value := 0
            taskGui["OfficeCheck"].Value := 0
            taskGui["HomeCheck"].Value := 0
            taskGui["GardenCheck"].Value := 0
            taskGui["ErrandsCheck"].Value := 1
            return 0
    }
}

; Function for Alt+Enter in Logseq
LogseqAddTodo() {
    ; Go to beginning of line
    SendInput "^{Enter}"

    ; Go to the end of the line
    SendInput "{End}"

    ; Press Shift+Enter to create a new line
    SendInput "+{Enter}"

    ; Type "context:: [["
    SendInput "context:: [[-/"

    return
}

; Tray menu handler for Reset Logseq Path
ResetLogseqPath(*) {
    global customDir, iniPath, VarScriptName, VarVersionNo

    result := MsgBox("Current path: " . customDir . "`n`nDo you want to select a new Logseq journal folder?", VarScriptName " - Reset Path", "YesNo Icon?")

    if (result = "Yes") {
        if newDir := DirSelect(, 3, "Select your Logseq journal folder") {
            customDir := newDir
            IniWrite(customDir, iniPath, "General", "CustomPath")
            TrayTip "Path updated to:`n" . customDir, VarScriptName " " VarVersionNo, 1
        }
    }
}

; Tray menu handler for About
ShowAbout(*) {
    global customDir, VarScriptName, VarVersionNo

    aboutText := VarScriptName . " " . VarVersionNo . "`n`n"
    aboutText .= "HOW TO USE:`n"
    aboutText .= "1. Select any text and press SHIFT+CTRL+L to capture it`n"
    aboutText .= "2. Choose task status (TODO/WAITING/DOING)`n"
    aboutText .= "3. Optionally select a context`n"
    aboutText .= "4. Click Submit to add to journal`n`n"
    aboutText .= "KEYBOARD SHORTCUTS (when not typing):`n"
    aboutText .= "T = TODO, W = WAITING, D = DOING`n"
    aboutText .= "1 = PC, 2 = Office, 3 = Home, 4 = Garden, 5 = Errands`n`n"
    aboutText .= "MULTILINE SUPPORT:`n"
    aboutText .= "First line becomes the task, remaining lines become sub-blocks`n`n"
    aboutText .= "CURRENT SETTINGS:`n"
    aboutText .= "Journal Path: " . customDir . "`n"

    MsgBox aboutText, "About " . VarScriptName, 64
}

;------------------------------------------------------------------------------
; Script Initialization
;------------------------------------------------------------------------------

;------------------------------------------------------------------------------
;Icon Tip
;------------------------------------------------------------------------------
A_IconTip := VarScriptName " " VarVersionNo " " Varblurb

;------------------------------------------------------------------------------
; Add ICON to your tray. REMEMBER to put an ICO file in same folder as the script.
;------------------------------------------------------------------------------
Try TraySetIcon(A_ScriptDir "\" VarScriptName ".ico")
Catch
    TrayTip "Remember to add " VarScriptName ".ico to same folder as " VarScriptName ".ahk", VarScriptName

;------------------------------------------------------------------------------
; Setup Tray Menu - Add custom items while keeping standard ones
;------------------------------------------------------------------------------
A_TrayMenu.Insert("1&", "About " . VarScriptName, ShowAbout)
A_TrayMenu.Insert("2&", "Reset Logseq Path", ResetLogseqPath)
A_TrayMenu.Insert("3&")  ; Separator

;------------------------------------------------------------------------------
; Check if INI file exists with path to folder where you want to add TODOs
;------------------------------------------------------------------------------
if !IniRead(iniPath, "General", "CustomPath", 0)
{
    ; Dialog for choosing folder
    MsgBox "Choose the folder where your journal files are.", VarScriptName " " VarVersionNo
    if !customDir := DirSelect()
        ; Warning that no folder is selected
        MsgBox "You have to select journalfolder for script to work.", "Error -" VarScriptName " " VarVersionNo
        ;~ ExitApp

    IniWrite(customDir, iniPath, "General", "CustomPath")
}
customDir := IniRead(iniPath, "General", "CustomPath")

; If the folder is selected show welcome message
If IniRead(iniPath, "General", "CustomPath", 0)
    TrayTip "Capturing to: " customDir "`nCapture to Logseq by pressing CTRL+Shift+L", VarScriptName " " VarVersionNo

;------------------------------------------------------------------------------
; Hotkeys
;------------------------------------------------------------------------------
; Main hotkey to launch the task input GUI
+^l:: {
    ; Save the current clipboard content
    oldClip := ClipboardAll()

    ; Clear the clipboard
    A_Clipboard := ""

    ; Capture selection by sending Ctrl+C
    Send "^c"

    ; Wait for the clipboard to contain data
    if ClipWait(1) {
        ; Show the GUI with the selected text
        clipText := A_Clipboard
        ShowLogseqAddGUI(clipText)
    } else {
        ; If nothing was selected, show an empty GUI
        ShowLogseqAddGUI("")
    }

    ; Restore the original clipboard
    A_Clipboard := oldClip
}

; Logseq TODO Workflow Script
; Only activate this hotkey when Logseq is the active window
#HotIf WinActive("ahk_exe Logseq.exe")
!Enter::LogseqAddTodo()
#HotIf